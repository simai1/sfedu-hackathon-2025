#!/bin/bash

# Скрипт для создания дистрибутива для распространения (macOS/Linux)

echo "========================================"
echo "Создание дистрибутива для распространения"
echo "========================================"
echo ""

# Определяем имя исполняемого файла в зависимости от ОС
if [[ "$OSTYPE" == "darwin"* ]]; then
    EXE_NAME="BitApp"
    DIST_NAME="BitApp-macOS"
elif [[ "$OSTYPE" == "linux-gnu"* ]]; then
    EXE_NAME="BitApp"
    DIST_NAME="BitApp-Linux"
else
    EXE_NAME="BitApp"
    DIST_NAME="BitApp"
fi

# Проверка наличия собранного приложения
if [ ! -f "dist/${EXE_NAME}" ]; then
    echo "[ОШИБКА] Исполняемый файл dist/${EXE_NAME} не найден!"
    echo "Сначала выполните сборку: ./build_macos.sh или ./build.sh"
    exit 1
fi

echo "[INFO] Найден исполняемый файл"
echo ""

# Создаем папку для дистрибутива
DIST_DIR="distribution"
if [ -d "$DIST_DIR" ]; then
    echo "[INFO] Удаление старой папки distribution..."
    rm -rf "$DIST_DIR"
fi

echo "[INFO] Создание структуры дистрибутива..."
mkdir -p "${DIST_DIR}/${DIST_NAME}"

# Копируем исполняемый файл
echo "[INFO] Копирование исполняемого файла..."
cp "dist/${EXE_NAME}" "${DIST_DIR}/${DIST_NAME}/"

# Делаем файл исполняемым
chmod +x "${DIST_DIR}/${DIST_NAME}/${EXE_NAME}"

# Копируем README для пользователя
echo "[INFO] Копирование документации..."
if [ -f "README_ПОЛЬЗОВАТЕЛЮ.md" ]; then
    cp "README_ПОЛЬЗОВАТЕЛЮ.md" "${DIST_DIR}/${DIST_NAME}/README.txt"
fi

# Создаем краткую инструкцию
echo "[INFO] Создание краткой инструкции..."
cat > "${DIST_DIR}/${DIST_NAME}/ИНСТРУКЦИЯ.txt" << 'EOF'
========================================
BIT APP - КРАТКАЯ ИНСТРУКЦИЯ
========================================

УСТАНОВКА:
----------
1. Распакуйте этот архив в любую папку
2. Запустите BitApp (или BitApp.app на macOS)

macOS:
------
При первом запуске macOS может блокировать приложение.
Откройте "Системные настройки" > "Безопасность" и разрешите запуск.

Linux:
------
Возможно потребуется установить зависимости:
sudo apt-get install libxcb-xinerama0 libxcb-cursor0

ИСПОЛЬЗОВАНИЕ:
--------------
1. Включите устройство BrainBit
2. В приложении нажмите "Обновить"
3. Выберите ваше устройство из списка
4. Следуйте инструкциям на экране

ПОДДЕРЖКА:
----------
Подробная инструкция в файле README.txt

========================================
EOF

# Создаем архив
echo ""
echo "[INFO] Создание ZIP архива..."
cd "$DIST_DIR"
zip -r "${DIST_NAME}.zip" "${DIST_NAME}/"
cd ..

echo ""
echo "========================================"
echo "Дистрибутив готов!"
echo "========================================"
echo ""
echo "Архив создан: ${DIST_DIR}/${DIST_NAME}.zip"
echo ""
echo "Для распространения:"
echo "1. Загрузите архив ${DIST_NAME}.zip на веб-сайт"
echo "2. Пользователи смогут скачать и запустить приложение"
echo ""

